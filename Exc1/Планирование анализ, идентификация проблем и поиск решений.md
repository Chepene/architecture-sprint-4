# Планирование: анализ, идентификация проблем и поиск решений

## Проблемные места (существующие и потенциальные)

+ долгое время загрузки страницы с заказами;
+ потери заказов:
  + критическая проблема: мы узнаем о потере заказа от клиентов;
  + неизвестен масштаб проблемы: нет данных о количестве и перечне заказов;
  + отсутствует понимание на каком этапе терятся заказы;
+ задержка релизов из-за high/critical багов на несколько дней или недель;
+ отсутствует автоматизация тестирования;
+ в пайплайне отсутствует запуск юнит-тестов при развертывании на release, prod окружениях;
+ в пайплайне отсутствует запуск автотестов при развертывании на все окружения;
+ QA перегружен;
+ отсутствует мониторинг;
+ MES API является критической точкой отказа системы: его недоступность блокирует расчет стоимости заказов, а также работу операторов и пользователей MES API;
+ БД и инстансы развернуты в единственном экземляре: высокие риски отказа;
+ инстансы развернуты на ЕС2: ограничивает гибкость, масштабируемость и усложняет управление. При росте нагрузки сложно будет развернуть несколько инстансов CRM API, Shop API, MES API и их поддерживать.

## Способы решения 

* Срочно надо локализовать проблему с потерянными заказами, проанализировать известные потерянные заказы, составить список всех потерянных заказов, передать их бизнесу, чтобы срочно запустить их в производство, связаться с клиентами, извиниться и смягчить ситуацию.

* Нам надо узнавать о проблемах раньше клиентов:
  * Развернем мониторинг: трейсы, логи, метрики
  * Настроим алерты
  

* Изменим флоу с тестированием: 
  * наймем еще 1 QA
  * сделаем упор на создание автотестов
  * внедрим в пайплайны на любом окружении запуск юнит- и автотестов


* Выделить расчет цены в отдельный модуль MES Calculator: 
  * взаимодействие MES API с MES Calculator тоже асинхронным, так как время расчета может достигать 30 минут 
  * уберем зависимость CRM от MES Api 
  * сможем масштабировать расчетчик при увеличении нагрузки


* Перейдем на докер-образы с использованием системы оркестрации - даст нам возможность быстро масштабироваться и поднимать несколько инстансов, уменьшит стоимость инфраструктуры, облегчит администрирование


* Можно настроить кластеры БД для увеличения доступности, но вырастет стоимость инфрастуктуры, поэтому тут надо согласовывать с бизнесом. Вполне возможно, что пока предпочтительно будет иметь риск кратковременной недоступности сайтов ради уменьшения стоимости инфры. 


* Ускорение страницу с заказами 

   Пока непонятна причина замедления: 

   * в таблице с заказами, скорее всего, меньше 500 000 записей - реляционка вполне должна справится 
     (Примерный расчет: если важен рост на 100 заказов каждый месяц, то навряд ли количество заказов в месяц больше 5000. Возьмем с лихвой - 10 000 заказов/мес на протяжении 2 лет: это всего 240 000 заказов. Это немного) 
   * разработчики сделали пагинацию и фильтры: мы стали забирать с БД больше меньшие объемы и передавать по сети меньше данных. Но раз проблема не решена, ту ли задачу решили разработчики? Пока выглядит, что что-то изменили без понимания проблемы
  
   Шаг 1. Надо найти где узкое место. Из наиболее вероятных:  
      * проблема на уровне БД
      * проблема в том, что MES API перегружен и ему не хватает ресурсов для выполнения текущего объема операций   

   Раз мониторинга нет: посмотрели с разработчиками сколько выполняется запрос на БД. 

   Если проблема в БД:

   Шаг 2:  
      * проверили бы сам запрос
      * проверили бы план запроса
      * проверили бы все необходимые индексы
      * если все, что выше - ок: посмотрели бы лочит ли что-то эти записи. при 10 000 записей в мес (3500 записей в день), всего около 8 записей заказов в минуту, это немного. Если долгая вставка/обновление, посмотрели бы, что с ними 
      * посмотрели бы с DevOps хватает ли ресурсов БД
    Думаю, что в жизни мы бы уже где-то тут разобрались.  
    Как максимум пришлось бы создать материлизованную вьюшку и читать с нее. или накинули бы ресурсов на БД. 
    Самый быстрый сейчас вариант решения, чтобы бизнес продолжил работу.
     
В рамках учебной задачи допустим, что выше все ок и запросы написаны грамотно и бд спроектирована хорошо, а ресуры уже не можем увеличивать.

Как альтернативные сценарии могли бы сделать кеш на заказы или поднять реплику БД для операций чтения. 
Эти решения имеют свою цену: 
* кэш - получим весь скоп дополнительных работ по поддержании актуальности кеша, его наполнении и тд.
* реплика - получим увеличение стоимости инфрастуктуры, увеличение сложности поддержки, увеличение сложности разработки, постоянное учитывание при разработке, что реплика может отставать от мастера. 

Решение бы принимала исходя из опыта и экспертизы команды.

## Инициативы в порядке приоритета

Часть инициатив мы можем распараллелить, так как они относятся к разным людям. Сейчас главное потушить пожар, сохранить репутацию и клиентов, и продолжить активный рост.

Для команды, чтобы работа велась в параллель:
  * обосновать для бизнеса необходимость нанять QA-тестировщика, отдать вакансию в работу HR
  * для Dev-Ops: встроить в пайпланы юнит- и авто- тесты
  * для QA: покрыть автотестами все критические сценарии

В это время архитектор+dev: 
  * Локализовать проблему с потерянными заказами, составить список потерянных заказов, передать бизнесу для планирования и запуска в производство, коммуникации с клиентами
  * Ускорить загрузку страницы заказов:
    * мы уже нашли потерянные заказы, нужно их срочно изготовить, для этого операторы должны их видеть
    * операторы должны заниматься производством, а не ожиданием загрузки. починим страницу - дадим людям делать свою работу

  * Настроить логирование
  * Настроить метрики и алерты
  * Настроить трейсы

  * Обучение команды использованию мониторинга

  * Разделить MES API на  MES API + MES Calculator 
  * Перевести инстансы на docker-контейнеры 



## Целевая архитектура через полгода

## 3 самых горячих инициативы






