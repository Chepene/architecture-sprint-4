# Выбор и настройка мониторинга

## Мотивация

В прошлом месяце мы потеряли крупные контракты из-за проблем с заказами. 
Клиенты не получают заказы вовремя, а о проблемах мы узнаём от них. Это разрушает доверие и вредит репутации.

Мы — растущий стартап, и наша задача — завоевать аудиторию. Для этого мы должны быть надёжными и доставлять заказы вовремя.  

Но не зная о проблемах системы, мы не можем их решать.

Мониторинг даст нам возможность:
+ выявлять и реагировать на проблемы до того, как они повлияют на клиентов
+ анализировать текущую производительность и готовится к дальнейшему росту
+ обнаруживать узкие места и точки отказа
+ отслеживать не только технические, но и бизнес-показатели: сколько заказов создано, сколько из доставлено с опозданием, сколько клиентов сделали еще один заказ и тд

Мониторинг - это фундамент стабильной работы. С ним мы можем не только устраним текущие проблемы, но и будем готовы к дальнейшему росту.

## Выбор подхода к мониторингу

### RED для Shop API, MES API, CRM API:

+ `Number of requests (RPS) for Shop API, MES API, CRM API` - частота запросов к API (ярлыки: `endpoint`, `instance`)
+ `Number of HTTP 500 for Shop API, MES API, CRM API` - количество ошибок к API (ярлыки: `endpoint`, `instance`)
+ `Response time (latency) for Shop API, MES API, CRM API` - время ответа API (ярлыки: `endpoint`, `instance`)
 
### USE для БД, Rabbit Mq, EC2, сервисов инфраструктуры:

**Rabbit MQ**:

+ `Number of dead-letter-exchange letters in RabbitMQ` - показывает количество сообщений, которые не удалось обработать (ярлыки: `queue_name`, `message_type`) 
+ `Number of message in flight in RabbitMQ` - показывает задержки в обработке сообщений (ярлыки: `queue_name`, `message_type`)


**Shop DB, MES DB**:

+ `Memory Utilisation for shop db instance` - показывает использование памяти на уровне базы данных. поможет следить за производительностью
+ `Number of connections for shop db instance` - показывает количество одновременных подключений. слишком большое число может указать на проблемы с пулом или утечки


**Инфраструктура**:

+ `Size of S3 storage/Size of db instance` - поможет следить за размером хранилищ для оптимизации арендованных ресурсов
+ `CPU % for shop API, CRM API, MES API` - поможет отслеживать загрузку процессора для каждого сервиса
+ `Memory Utilisation for shop API, CRM API, MES API` - поможет отслеживать утечку памяти и возможные перегрузки


### План действий

Для метрики выберем связку Prometheus + Grafana

Для разработчиков:

1. Доработать shop API, MES API, CRM API так, чтобы по endpoint /metrics представлялись метрики сервиса в формате Prometheus

Для девопса:

1. Создать в облаке Managed Service for Prometheus
2. Развернуть Grafana
3. Настроить роли для admin, dev, devops и business
5. Подключить shop API, MES API, CRM API к Managed Service for Prometheus, настроить дэшборды и алерты
6. Настроить экспортеры метрик для db, rabbit mq, ec2, настроить дэшборды и алерты

